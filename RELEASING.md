# Releasing

When there is a need to release a new version, we should create a release in two places: GitHub and npm. Follow the instructions below to first bump the version, then create a GitHub release and then publish a new version of the package in npm.

To release the npm package under the `@fintraffic` npm scope, you need to have at least Member permissions in the [fintraffic](https://www.npmjs.com/org/fintraffic) npm organization

Once you have access, make sure you're logged into npm on the command line:

```shell
npm login
```

## 1. Update the version in package.json

> Currently pushing directly to `main` branch is not allowed due to branch protection rules so you can't directly push the commit generated by `npm version` into `main`. So we need to first create a release branch for getting the `package.json` version update merged via a pull request.

Make sure you are on the correct branch (usually we would want to release from `main`) in a clean state with no uncommitted changes.

> NOTE: replace `0.1.1` wit the version number you are planning to release in all the following commands.

### Create a release branch

```shell
# create a release branch
git switch -c release-v0.1.1

# bump version in package.json and tag it in git (this creates a new commit)
npm version 0.1.1 -m "chore(release): 0.1.1"

git push origin release-v0.1.1
```

### Create a PR

After the above you need to create a [PR](https://github.com/fintraffic-design/fds-coreui-components/pulls) from the release branch into master.

The PR needs to be reviewed and approved to be able to merge it. If you have admin permissions to the repository however, you can merge the version bump PR directly without waiting for review/approval (this is ok only for simple version bump PRs, code changes should still go through the normal review process).

## 2. Create a GitHub release

After the PR has been approved and merged you need to create a GitHub release from https://github.com/fintraffic-design/fds-coreui-components/releases/new

The tag of the release should be just the version number prefixed with "v". For example "v0.1.1". You can see the previous [releases](https://github.com/fintraffic-design/fds-coreui-components/releases/) for reference.

Target should be `main`.

The title should be the same as the tag.

Check the "Set as a pre-release" checkbox if you're releasing a 0.x.x version or a version that includes a semver [pre-release tag](https://docs.npmjs.com/cli/v6/using-npm/semver#prerelease-tags).

Use the "Generate release notes" button in GitHub to help generate a template and edit it as necessary.

### Cleanup and sync git tag

After the GitHub release has been published you need to do a bit of cleanup if you want to synchronize the new release tag name to your local clone. This is because `npm version` already created the version tag for you but it is no longer pointing to the same commit as the public version bump commit (assuming that the PR was rebased or squashed).

```shell
# remove the local tag created by "npm version"
git tag --delete v0.1.1
git fetch --all --tags
```

## 3. Publish new version in the npm registry

For more info see the docs for [npm publish](https://docs.npmjs.com/cli/commands/npm-publish).

For testing the npm package before publishing you can use [npm pack](https://docs.npmjs.com/cli/commands/npm-pack).

```shell
# checkout the release tag
git checkout v0.1.1

# cleanup old build files
# (TODO: this could be handled automatically by the build script using rimraf)
rm -rf dist

# build files needed for published package
npm run build

# if you want to test/verify what exactly the published package will contain or
# how it will function before publishing, you can use "npm pack" at this
# point to create a tarball of the package and you can install that in a test
# project with "npm install ../path/to/file.tgz"

# publish to npm
npm publish
```
